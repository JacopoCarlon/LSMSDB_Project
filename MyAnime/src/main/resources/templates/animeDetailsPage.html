<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta content="width=device-width, initial-scale=1" name="viewport">

        <title th:text="${animeDetails.title}"></title>
        <meta content="" name="description">
        <meta content="" name="keywords">

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="/img/mc_bookshelf.png">


        <!-- Main CSS File -->
        <link href="css/style.css" rel="stylesheet">
        <link href="../static/css/style.css" rel="stylesheet">

        <!-- AOS : Animation On Scroll -->
        <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
        
        <!-- AJAX jQuery-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../local/jquery-3.6.1.min.js">\x3C/script>')</script>
        
        <!-- JavaScript-->
        <script src="js/search_btn.js" type="text/javascript"></script>
        <script src="js/searchBar.js" type="text/javascript"></script>
        <script src="js/logout_btn.js" type="text/javascript"></script>

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    </head>
    <body>
        <div class="main">
            <!-- Value taken by Thymeleaf to understand if the user is logged in and if he is an admin -->
            <input type="hidden" id="is_logged" th:value="${logged}"/>
            <input type="hidden" id="is_admin" th:value="${is_admin}"/>
            <!-- Dynamic header -->
            <header class="header sticky-top shadow">

            </header>
            <!-- End header -->
            <section id="hero" class="d-flex flex-column align-items-center container-fluid p-3">
                <div class="gap-1 d-flex flex-column container-fluid justify-content-center" data-aos="zoom-in" data-aos-delay="150">
                    <div id="anime_info" class="d-flex mb-1 align-items-center col-md-12">
                        <img id="anime_cover" class="anime-cover" th:src="${animeDetails.imgURL}" alt="Copertina Anime"/>
                        <div id="anime_details" class="anime-details d-flex flex-column">
                            <div id="anime_title"            class="row" th:text="${animeDetails.title}"></div>
                            <div id="anime_title_jap"        class="row" th:text="${animeDetails.titleJapanese}"></div><div class="w-100"></div>
                            <div id="anime_type"             class="row" th:text="${animeDetails.type}"></div><div class="w-100"></div>
                            <div id="anime_source"           class="row" th:text="${animeDetails.source}"></div><div class="w-100"></div>
                            <div id="anime_episodes"         class="row" th:text="${animeDetails.episodes}"></div>
                            <div id="anime_episodeDuration"  class="row" th:text="${animeDetails.episodeDuration} + 'minutes'"></div><div class="w-100"></div>
                            <div id="anime_airingst"         class="row" th:text="${animeDetails.airing}"></div>
                            <div id="anime_aired"            class="row" th:text="${animeDetails.aired}"></div><div class="w-100"></div>
                            <div id="anime_watchers"         class="row" th:text="${animeDetails.watchers}"></div><div class="w-100"></div>
                            <div id="anime_synopsis"         class="row" th:text="${animeDetails.synopsis}"></div><div class="w-100"></div>
                            <div id="anime_broadcast"        class="row" th:text="${animeDetails.broadcast}"></div>
                            <div id="anime_producer"         class="row" th:text="${animeDetails.producer}"></div>
                            <div id="anime_licensor"         class="row" th:text="${animeDetails.licensor}"></div>
                            <div id="anime_genrelist"        class="row" th:text="${animeDetails.genre}"></div><div class="w-100"></div>
                            <div class="d-flex mt-0 mb-0 gap-3 align-items-center">
                                <p id="anime_duration_page" th:text="${animeTotalDuration}"></p>
                            </div>
                            <div class="d-flex gap-3">
                                <div id="like_anime_container" class="d-flex w-25 align-items-center">
                                    <button id="like_anime_btn" class="btn btn-danger ms-1" type="button" >
                                        <i class="fas fa-heart me-1"></i>Like
                                    </button>
                                    <div id="number_of_likes_anime" class="ms-3" th:text="${animeDetails.scoredBy}"></div>
                                </div>
                                <div id="average_rating_container" class="d-flex w-25 align-items-center">
                                    <span class="text-bg-warning p-3">
                                        Average rating
                                    </span>
                                    <i class="fa fa-star me-1 ps-3"></i>
                                    <div id="average_rating" th:text="${animeDetails.averageScore}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-1">
                        <div class="d-flex flex-column col-md-6">
                            <div id="anime_reviews" class="d-flex flex-column">
                                <div id="latest_reviews" class="d-flex flex-column row-gap-1 p-1">
                                    <h1 style="text-align: center">Last 5 reviews</h1>
                                    <div th:each="review : ${animeDetails.mostRecentReviews}" class="anime-review d-flex flex-column p-3">
                                        <div class="d-flex align-items-center gap-1">
                                            <h4 th:text="${review.username}" class="user_review"></h4>
                                            <h5 class="rating_review text-bg-dark p-1 ps-3 pe-3">
                                                <i class="fas fa-star me-1"></i>
                                                <span th:text="${review.score}"></span>
                                            </h5>
                                        </div>
                                        <div th:text="${review.text}" class="text_review"></div>
                                    </div>
                                </div>
                                <div class="d-flex gap-1">
                                    <button id="animeReviews_btn" class="btn btn-primary mt-1 col-6" type="button">View all the reviews</button>
                                    <button id="writeReview_btn" class="btn btn-primary mt-1 col-6" type="button">Write a review</button>
                                </div>
                            </div>
                        </div>
                    </div>
              </div>
            </section>
        </div>

        <!-- JavaScript's management of the buttons -->
        <script th:inline="javascript">
            //  TODO : fix this buttons please, need to interact proprly con DB for details review and animeID
            //  TODO : do API corresponding 
            $(document).ready(function () {
                let animeId = /*[[${animeDetails.id}]]*/ null;
                let logged = /*[[${logged}]]*/ true;
                let username = /*[[${session.username}]]*/ null;
                
                let do_buttons = true;
                if (animeId == null) {
                    alert("animeId is null");
                }
                //  else {
                if (do_buttons) {
                    let viewAllReviewBtn = $("#animeReviews_btn");
                    if (viewAllReviewBtn != null) {
                        $(viewAllReviewBtn).click(function (){
                            window.location.href = '/animeReviewsPage?animeId=' + animeId;
                        });
                    } else
                        alert("viewAllReviewBtn not found");

                    let writeReviewBtn = $("#writeReview_btn");
                    if (logged === false)
                        ;
                    else if (writeReviewBtn !== null) {
                        $(writeReviewBtn).click(function (){
                            window.location.href = '/writeReviewPage?animeId=' + animeId;
                        });
                    } else
                        alert("writeReviewBtn not found");

                    if (logged === true && username != null) {
                        const likeAnimeBtn = $("#like_anime_btn");
                        $(likeAnimeBtn).click(function () {
                            let animeTitle = /*[[${animeDetails.title}]]*/ null;

                            $.ajax({
                                url: '/api/addLikesAnime',
                                dataType: 'json',
                                type: 'POST',
                                data: {
                                    username: username,
                                    animeTitle: animeTitle
                                },
                                success: function (response) {
                                    if (response.outcome_code == 0){
                                        likeAnimeBtn.css("background-color", "green");
                                        likeAnimeBtn.css("border-color", "green");
                                    }
                                    else if (response.outcome_code == 1)
                                        alert("You have already liked this anime");
                                    else
                                        alert("Error occurred while adding like to anime");
                                },
                                error: function (xhr, status, error) {
                                    console.log("ERROR: " + error);
                                }
                            });
                        });

                        
                    }
                }
            });
        </script>

        <!-- AOS JavaScript -->
        <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
        <script>
            AOS.init();
        </script>

        <!-- Bootstrap JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </body>
</html>